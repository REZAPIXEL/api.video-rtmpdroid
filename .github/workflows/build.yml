name: build-rtmpdroid-16kb

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install NDK r28 + CMake
        run: |
          yes | sdkmanager "ndk;28.0.13004108" "cmake;3.22.1"

      # ✅ مهم: خیلی از پروژه‌ها ndkVersion=26 دارن و باعث میشه دوباره NDK 26 نصب/استفاده بشه
      - name: Force ndkVersion to r28 (if defined)
        run: |
          set -eux
          echo "---- ndkVersion before ----"
          grep -R --line-number "ndkVersion" . || true

          find . \( -name "*.gradle" -o -name "*.gradle.kts" \) -print0 | while IFS= read -r -d '' f; do
            # Groovy DSL: ndkVersion "26.1.10909125"
            sed -i 's/ndkVersion[[:space:]]*["'\'']26\.[0-9.]*["'\'']/ndkVersion "28.0.13004108"/g' "$f" || true
            # Groovy/KTS: ndkVersion = "26.1.10909125"
            sed -i 's/ndkVersion[[:space:]]*=[[:space:]]*["'\'']26\.[0-9.]*["'\'']/ndkVersion = "28.0.13004108"/g' "$f" || true
          done

          echo "---- ndkVersion after ----"
          grep -R --line-number "ndkVersion" . || true

      - name: Build Release AAR
        run: |
          chmod +x gradlew
          # اول تلاش با ماژول lib، اگر نبود کل پروژه Release را می‌سازد
          ./gradlew :lib:assembleRelease --no-daemon --stacktrace || ./gradlew assembleRelease --no-daemon --stacktrace

          echo "---- AAR outputs ----"
          find . -path "*build/outputs/aar*" -name "*.aar" -maxdepth 12 -print || true

      - name: Prepare artifact
        run: |
          set -eux
          mkdir -p out
          AAR_PATH=$(find . -path "*build/outputs/aar*" -name "*release*.aar" | head -n 1 || true)
          if [ -z "${AAR_PATH}" ]; then
            echo "❌ No release AAR found!"
            find . -path "*build/outputs*" -maxdepth 6 -print || true
            exit 1
          fi
          echo "Picked AAR: $AAR_PATH"
          cp "$AAR_PATH" out/rtmpdroid-1.2.1.aar
          ls -lah out

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rtmpdroid-1.2.1-16kb
          path: out/rtmpdroid-1.2.1.aar
