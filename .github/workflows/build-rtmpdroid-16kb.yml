name: rtmpdroid-16kb-aar

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install host deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake make perl git unzip zip

      # ✅ خیلی مهم: برای git am (patch step) باید identity ست شود
      - name: Configure git identity (required for git am)
        run: |
          git config --global user.name "REZAPIXEL"
          git config --global user.email "mohamadrezap.o@gmail.com"

      # ✅ خیلی مهم: هرجا پروژه خواست از git.ffmpeg.org کلون کنه، به GitHub mirror هدایتش کن
      - name: Rewrite rtmpdump URL globally (avoid git.ffmpeg.org 502)
        run: |
          git config --global url."https://github.com/rtmpdump/rtmpdump.git".insteadOf "http://git.ffmpeg.org/rtmpdump/"
          git config --global url."https://github.com/rtmpdump/rtmpdump.git".insteadOf "http://git.ffmpeg.org/rtmpdump"
          git config --global url."https://github.com/rtmpdump/rtmpdump.git".insteadOf "https://git.ffmpeg.org/rtmpdump/"
          git config --global url."https://github.com/rtmpdump/rtmpdump.git".insteadOf "https://git.ffmpeg.org/rtmpdump"
          git config --global url."https://github.com/rtmpdump/rtmpdump.git".insteadOf "git://git.ffmpeg.org/rtmpdump"

      - name: Install SDK/NDK/CMake
        run: |
          yes | sdkmanager --licenses
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-35" \
            "build-tools;35.0.0" \
            "cmake;3.22.1" \
            "ndk;28.0.13004108"

      - name: Export paths (SDK/NDK/CMake)
        run: |
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}" >> $GITHUB_ENV
          echo "ANDROID_HOME=${ANDROID_SDK_ROOT}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/28.0.13004108" >> $GITHUB_ENV
          echo "NDK_HOME=${ANDROID_SDK_ROOT}/ndk/28.0.13004108" >> $GITHUB_ENV
          echo "CMAKE_DIR=${ANDROID_SDK_ROOT}/cmake/3.22.1" >> $GITHUB_ENV

      # ✅ مهم‌ترین فیکس: حذف mismatch نسخه ndkVersion / android.ndkVersion
      - name: Force NDK version to 28 everywhere (no commit)
        run: |
          set -eux

          echo "---- BEFORE: occurrences ----"
          grep -R --line-number -E "ndkVersion|android\.ndkVersion" . || true

          # 1) gradle.properties: android.ndkVersion=26.1.10909125
          find . -name "gradle.properties" -print0 | while IFS= read -r -d '' f; do
            sed -i 's/^android\.ndkVersion=.*/android.ndkVersion=28.0.13004108/g' "$f" || true
          done

          # 2) build.gradle / build.gradle.kts: ndkVersion "26.x"  یا ndkVersion = "26.x"
          find . \( -name "*.gradle" -o -name "*.gradle.kts" \) -print0 | while IFS= read -r -d '' f; do
            sed -i 's/ndkVersion[[:space:]]*["'\''"]26\.[0-9.]*["'\''"]/ndkVersion "28.0.13004108"/g' "$f" || true
            sed -i 's/ndkVersion[[:space:]]*=[[:space:]]*["'\''"]26\.[0-9.]*["'\''"]/ndkVersion = "28.0.13004108"/g' "$f" || true
          done

          echo "---- AFTER: occurrences ----"
          grep -R --line-number -E "ndkVersion|android\.ndkVersion" . || true

      # (اختیاری ولی بد نیست) اگر داخل سورس هم URL صریح بود، patch هم می‌کنیم
      - name: Patch rtmpdump URL in project files (best-effort)
        run: |
          set -eux
          echo "---- Searching rtmpdump URL ----"
          grep -R --line-number -E "git\.ffmpeg\.org/rtmpdump|rtmpdump" lib || true

          find lib -type f \( -name "CMakeLists.txt" -o -name "*.cmake" \) -print0 | while IFS= read -r -d '' f; do
            sed -i 's|http://git\.ffmpeg\.org/rtmpdump/?|https://github.com/rtmpdump/rtmpdump.git|g' "$f" || true
            sed -i 's|https://git\.ffmpeg\.org/rtmpdump/?|https://github.com/rtmpdump/rtmpdump.git|g' "$f" || true
            sed -i 's|git://git\.ffmpeg\.org/rtmpdump/?|https://github.com/rtmpdump/rtmpdump.git|g' "$f" || true
          done

          echo "---- After patch ----"
          grep -R --line-number -E "git\.ffmpeg\.org/rtmpdump|https://github.com/rtmpdump/rtmpdump\.git" lib || true

      - name: Create local.properties (force sdk/ndk/cmake)
        run: |
          cat > local.properties <<EOF
          sdk.dir=${ANDROID_SDK_ROOT}
          ndk.dir=${ANDROID_SDK_ROOT}/ndk/28.0.13004108
          cmake.dir=${ANDROID_SDK_ROOT}/cmake/3.22.1
          EOF
          cat local.properties

      - name: Build Release AAR
        env:
          CMAKE_BUILD_PARALLEL_LEVEL: "2"
          NINJAFLAGS: "-j2"
          MAKEFLAGS: "-j2"
        run: |
          chmod +x gradlew
          ./gradlew :lib:assembleRelease \
            --no-daemon --stacktrace --info \
            -Dorg.gradle.workers.max=2

      - name: Prepare artifact
        run: |
          set -eux
          mkdir -p out
          echo "---- AAR outputs ----"
          find lib/build/outputs/aar -maxdepth 2 -type f -name "*.aar" -print || true
          AAR_PATH=$(find lib/build/outputs/aar -maxdepth 2 -type f -name "*release*.aar" | head -n 1 || true)
          if [ -z "${AAR_PATH}" ]; then
            echo "❌ No release AAR found!"
            find lib/build -maxdepth 6 -type f -print || true
            exit 1
          fi
          echo "Picked: $AAR_PATH"
          cp "$AAR_PATH" out/rtmpdroid-1.2.1-16kb.aar
          ls -lah out

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rtmpdroid-1.2.1-16kb
          path: out/rtmpdroid-1.2.1-16kb.aar
          retention-days: 7

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            lib/.cxx/**/*
            **/build/reports/**/*
          retention-days: 7
